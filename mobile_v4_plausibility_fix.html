<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Stückleistung – Mobile</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#0b0f1a; --muted:#5b6475;
      --border:#e8ecf4; --shadow:0 10px 28px rgba(0,0,0,.08);
      --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
      --r:18px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1020; --card:#0f1730; --text:#f3f6ff; --muted:#b4bed3;
        --border:#223055; --shadow:0 10px 28px rgba(0,0,0,.35);
      }
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
    }
    .wrap{max-width:560px;margin:0 auto;padding:14px 12px 26px}
    header{
      position:sticky;top:0;z-index:5;
      padding:10px 12px 8px;
      backdrop-filter:saturate(180%) blur(10px);
      background:color-mix(in srgb, var(--bg) 82%, transparent);
      border-bottom:1px solid color-mix(in srgb, var(--border) 55%, transparent);
    }
    .title{display:flex;align-items:center;justify-content:space-between;gap:10px}
    h1{margin:0;font-size:16px;letter-spacing:.2px}
    .mini{font-size:12px;color:var(--muted)}
    .btn{
      border:1px solid var(--border); background:var(--card); color:var(--text);
      padding:10px 12px; border-radius:14px; font-size:14px; font-weight:700;
      box-shadow:0 1px 0 rgba(0,0,0,.03);
    }
    .btn:active{transform:translateY(1px)}
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--r); box-shadow:var(--shadow);
      padding:14px; margin-top:12px;
    }
    .kpiGrid{display:grid;gap:10px}
    .kpi{
      padding:12px; border-radius:16px;
      border:1px solid color-mix(in srgb, var(--border) 75%, transparent);
      background:color-mix(in srgb, var(--card) 92%, var(--bg));
    }
    .kpi .t{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:34px; font-weight:900; margin-top:6px; letter-spacing:-.6px}
    .kpi .u{font-size:12px;color:var(--muted); margin-top:2px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;font-weight:900;font-size:13px;
      border:1px solid color-mix(in srgb, var(--border) 65%, transparent);
      background:color-mix(in srgb, var(--card) 92%, var(--bg));
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--muted)}
    .pill.ok .dot{background:var(--ok)}
    .pill.warn .dot{background:var(--warn)}
    .pill.bad .dot{background:var(--bad)}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:14px;font-weight:800;font-size:12px;
      border:1px dashed color-mix(in srgb, var(--border) 75%, transparent);
      color:var(--muted);
      background:color-mix(in srgb, var(--card) 88%, var(--bg));
    }

    .inputs{display:grid;gap:10px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input{
      width:100%; padding:14px 14px; font-size:18px; font-weight:800;
      border-radius:16px; border:1px solid var(--border);
      background:color-mix(in srgb, var(--card) 90%, var(--bg));
      color:var(--text); outline:none;
    }
    input:focus{border-color:color-mix(in srgb, #7aa7ff 55%, var(--border)); box-shadow:0 0 0 4px rgba(122,167,255,.18)}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hint{margin-top:10px;font-size:13px;color:var(--muted);line-height:1.35}
    details{margin-top:10px}
    summary{cursor:pointer; font-weight:800; color:var(--text); list-style:none}
    summary::-webkit-details-marker{display:none}
    .adv{margin-top:10px;display:grid;gap:10px}
    .tiny{font-size:12px;color:var(--muted);line-height:1.35}
    .footerRow{display:flex;gap:10px;margin-top:10px}
    .footerRow .btn{flex:1}
    .safeBottom{height:env(safe-area-inset-bottom)}
  </style>
</head>
<body>
<header>
  <div class="title">
    <div>
      <h1>Stückleistung</h1>
      <div class="mini">Mobile Tagessteuerung</div>
    </div>
    <button class="btn" id="resetBtn" type="button">Reset</button>
  </div>
</header>

<div class="wrap">

  <div class="card">
    <div class="kpiGrid">
      <div class="kpi">
        <div class="t">Benötigt ab jetzt</div>
        <div class="v" id="need">–</div>
        <div class="u">Stk/Std (Rest)</div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:4px;flex-wrap:wrap">
        <div class="pill" id="statusPill"><span class="dot"></span><span id="statusTxt">–</span></div>
        <div class="tiny" id="restInfo">Reststunden: –</div>
      </div>

      <div id="modeBadge" class="badge" style="display:none">⚠️ Schnellmodus: Ohne Gesamtstunden/geleistete Stunden wird „Benötigt ab jetzt“ = Zielwert angezeigt.</div>

      <div class="row2" style="margin-top:6px">
        <div class="kpi">
          <div class="t">Fehlende Stück bis Ziel</div>
          <div class="v" style="font-size:26px" id="fehl">–</div>
          <div class="u">Stück</div>
        </div>
        <div class="kpi">
          <div class="t">Aktuelle Stückleistung (Ist)</div>
          <div class="v" style="font-size:26px" id="ist">–</div>
          <div class="u">Stk/Std (bisher)</div>
        </div>
      </div>

      <div class="hint" id="hint">Gib unten Ziel, Stück bisher und Reststunden ein.</div>
    </div>
  </div>

  <div class="card">
    <div class="inputs">
      <div class="row2">
        <div>
          <label>Ziel (Stk/Std)</label>
          <input id="ziel" type="number" inputmode="decimal" step="0.1" min="0" placeholder="z.B. 40" />
        </div>
        <div>
          <label>Stück bisher</label>
          <input id="stueck" type="number" inputmode="numeric" step="1" min="0" placeholder="z.B. 820" />
        </div>
      </div>

      <div>
        <label>Reststunden ab jetzt (Einsatzstunden)</label>
        <input id="rest" type="number" inputmode="decimal" step="0.25" min="0" placeholder="z.B. 12.5" />
        <div class="tiny">Wichtig: <b>Einsatzstunden</b> (Summe Mitarbeitendenstunden) – nicht nur Öffnungszeit.</div>
      </div>

      <details>
        <summary>Exakte Berechnung (empfohlen)</summary>
        <div class="adv">
          <div class="row2">
            <div>
              <label>Bereits geleistete Stunden</label>
              <input id="hBis" type="number" inputmode="decimal" step="0.25" min="0" placeholder="z.B. 18.0" />
              <div class="tiny">Damit wird „Ist“ korrekt berechnet.</div>
            </div>
            <div>
              <label>Geplante Gesamtstunden</label>
              <input id="hTotal" type="number" inputmode="decimal" step="0.25" min="0" placeholder="z.B. 30.5" />
              <div class="tiny">Damit werden „fehlende Stück“ & „benötigt ab jetzt“ exakt.</div>
            </div>
          </div>
          <div class="tiny">
            Ohne <b>Gesamtstunden</b> kann das Tool das Tages-Ziel in Stück nicht eindeutig bestimmen.
            Dann zeigt es im Schnellmodus bei „Benötigt ab jetzt“ nur den Zielwert.
          </div>
        </div>
      </details>

      <div class="footerRow">
        <button class="btn" id="saveHomeTip" type="button">Zum Home-Bildschirm</button>
        <button class="btn" id="clearLocal" type="button">Eingaben löschen</button>
      </div>
      <div class="tiny" id="savedNote">Eingaben werden automatisch auf diesem Gerät gespeichert.</div>
    </div>
  </div>

  <div class="safeBottom"></div>
</div>

<script>
  const $ = (id)=>document.getElementById(id);

  const ids = ["ziel","stueck","rest","hBis","hTotal"];
  function num(v){ const n = parseFloat(v); return Number.isFinite(n) ? n : NaN; }
  function n0(v){ const n = parseFloat(v); return Number.isFinite(n) ? n : 0; }
  function fmt(n, d=1){
    if (!Number.isFinite(n)) return "–";
    return n.toFixed(d).replace(".", ",");
  }
  function fmtInt(n){
    if (!Number.isFinite(n)) return "–";
    return Math.round(n).toString();
  }

  function load(){
    ids.forEach(id=>{
      const v = localStorage.getItem("slm_"+id);
      if (v !== null) $(id).value = v;
    });
  }
  function save(){
    ids.forEach(id=>{
      localStorage.setItem("slm_"+id, $(id).value ?? "");
    });
  }
  function setPill(kind, text){
    const pill = $("statusPill");
    pill.className = "pill" + (kind ? (" " + kind) : "");
    $("statusTxt").textContent = text || "–";
  }

  function calc(){
    save();

    const ziel = num($("ziel").value);
    const stueck = n0($("stueck").value);
    const hRest = num($("rest").value);

    const hBis = num($("hBis").value);
    const hTotal = num($("hTotal").value);

    // IST
    const ist = (Number.isFinite(hBis) && hBis > 0) ? (stueck / hBis) : NaN;
    $("ist").textContent = fmt(ist,1);

    // Determine total target pieces if possible
    const totalHours = (Number.isFinite(hTotal) && hTotal > 0) ? hTotal
                     : (Number.isFinite(hBis) && Number.isFinite(hRest) ? (hBis + hRest) : NaN);

    const zielStkTotal = (Number.isFinite(ziel) && Number.isFinite(totalHours)) ? ziel * totalHours : NaN;
    const fehl = Number.isFinite(zielStkTotal) ? Math.max(zielStkTotal - stueck, 0) : NaN;
    $("fehl").textContent = fmtInt(fehl);

    // Needed from now
    let need = NaN;
    let isFastMode = false;

    if (Number.isFinite(hRest) && hRest > 0){
      if (Number.isFinite(fehl)) {
        need = fehl / hRest;
      } else if (Number.isFinite(ziel)) {
        // Fast mode fallback
        need = ziel;
        isFastMode = true;
      }
    } else if (Number.isFinite(hRest) && hRest === 0){
      need = (Number.isFinite(fehl) && fehl > 0) ? Infinity : 0;
    }

    $("need").textContent = (need === Infinity) ? "∞" : fmt(need,1);
    $("restInfo").textContent = Number.isFinite(hRest) ? ("Reststunden: " + fmt(hRest,2)) : "Reststunden: –";

    $("modeBadge").style.display = isFastMode ? "block" : "none";

    // Status pill
    if (Number.isFinite(ziel) && ziel > 0 && Number.isFinite(ist)){
      const diff = ist - ziel;
      if (diff >= 0.5) setPill("ok", "Über Ziel");
      else if (diff >= -0.5) setPill("warn", "Knapp");
      else setPill("bad", "Unter Ziel");
    } else {
      setPill("", "–");
    }

    // Hint
    const hint = $("hint");
    if (!Number.isFinite(ziel) || ziel <= 0){
      hint.textContent = "Bitte Ziel (Stk/Std) eintragen.";
      return;
    }
    if (!Number.isFinite(hRest)){
      hint.textContent = "Bitte Reststunden ab jetzt eintragen (Einsatzstunden).";
      return;
    }
    if (hRest === 0){
      hint.textContent = (Number.isFinite(fehl) && fehl === 0) ? "Tagesziel erreicht ✅" : "Reststunden = 0. (Wenn noch Zeit/Personal kommt, Reststunden anpassen.)";
      return;
    }
    if (need === Infinity){
      hint.textContent = "Keine Reststunden mehr – Ziel kann nicht mehr aufgeholt werden.";
      return;
    }
    if (isFastMode){
      hint.textContent = "Schnellmodus: Für exakte „fehlende Stück“ bitte „Gesamtstunden“ (oder „Stunden bisher“) öffnen und eintragen.";
      return;
    }
    hint.textContent = "Ab jetzt brauchst du ca. " + (Number.isFinite(need) ? fmt(need,1) : "–") + " Stk/Std.";
  }

  $("resetBtn").addEventListener("click", ()=>{
    ids.forEach(id=>$(id).value="");
    calc();
  });

  $("clearLocal").addEventListener("click", ()=>{
    ids.forEach(id=>localStorage.removeItem("slm_"+id));
    $("savedNote").textContent = "Eingaben gelöscht.";
    setTimeout(()=>$("savedNote").textContent="Eingaben werden automatisch auf diesem Gerät gespeichert.", 1200);
  });

  $("saveHomeTip").addEventListener("click", ()=>{
    alert("iPhone: Safari → Teilen → „Zum Home-Bildschirm“.\nAndroid: Browser-Menü → „Zum Startbildschirm hinzufügen“.");
  });

  ids.forEach(id => $(id).addEventListener("input", calc));

  load();
  calc();
</script>
</body>
</html>
